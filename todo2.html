<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ToDo</title>
<style>
  :root{
    --bg:#fafafa; --card:#fff; --accent:#0a84ff;
    --danger:#ff3b30; --warn:#ffcc00; --muted:#666;
    --success:#22c55e;
    --radius:12px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo;background:var(--bg);color:#111}
  .wrap{max-width:420px;margin:8px auto;padding:12px}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 6px rgba(0,0,0,.06);padding:12px;margin-top:10px;border:1px solid #eee}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="datetime-local"], textarea, select{
    width:100%;padding:10px;border:1px solid #e6e6e6;border-radius:10px;font-size:15px;box-sizing:border-box;
  }
  textarea{min-height:70px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:600;font-size:14px}
  .btn.secondary{background:#e6e6e6;color:#111}
  .list{margin-top:10px}
  .todo{display:flex;flex-direction:column;gap:8px;padding:10px;border-radius:10px;border:1px solid #eee;margin-bottom:8px;background:#fff}
  .todoRow{display:flex;align-items:center;gap:8px}
  .left{flex:1;min-width:0;cursor:default}
  .title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:6px}
  .smallBtn{padding:6px 8px;font-size:13px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
  .pinBtn{background:#fff;border:1px solid #ffd700}
  .pinBtn.pinned{background:#ffd700}
  .completeBtn{background:var(--success);color:#fff;border:none}
  .deleteBtn{background:var(--danger);color:#fff;border:none}
  .completed .title{text-decoration:line-through;color:#999}
  .tag-danger{background:var(--danger);color:#fff;padding:4px 6px;border-radius:6px;font-size:12px}
  .tag-warn{background:var(--warn);color:#111;padding:4px 6px;border-radius:6px;font-size:12px}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .expired-card{border-color:var(--danger);}
  .memo{background:#f7f7f7;padding:8px;border-radius:8px;font-size:14px;color:#222;border:1px dashed #eee}
  .small-select{font-size:13px;padding:6px;border-radius:8px;width:170px}
  @media (max-width:380px){
    .wrap{padding:10px}
    .btn{font-size:13px;padding:8px}
    .small-select{width:140px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ToDo</h1>
    </header>

    <div class="card" id="creator">
      <label for="title">New ToDo</label>
      <input id="title" type="text" placeholder="タイトル" />
      <label for="memo">メモ（オプション）</label>
      <textarea id="memo" placeholder=""></textarea>
      <label for="deadline">期限</label>
      <input id="deadline" type="datetime-local" />
      <div style="margin-top:8px" class="row">
        <button id="addBtn" class="btn">Add</button>
        <button id="clearAll" class="btn secondary">Clear All</button>
      </div>
    </div>

    <div class="card" id="activeCard">
      <div class="section-title">
        <div>Active Todos <span id="countActive" class="muted"></span></div>
        <div>
          <select id="sortSelect" class="small-select" aria-label="並び順">
            <option value="pin_then_deadline">ピン優先 → 期限順</option>
            <option value="deadline_asc">期限昇順（近い順）</option>
            <option value="deadline_desc">期限降順（遠い順）</option>
            <option value="created_asc">作成順（古い→新しい）</option>
          </select>
        </div>
      </div>
      <div id="todoList" class="list"></div>
    </div>

    <div class="card expired-card" id="expiredCard">
      <div class="section-title">
        <div>Expired</div>
        <div class="muted small"></div>
      </div>
      <div id="expiredList" class="list"></div>
    </div>

    <div class="card" id="doneCard">
      <div class="section-title">
        <div>達成済み</div>
        <div class="muted small">達成済みはページ更新で削除されます</div>
      </div>
      <div id="doneList" class="list"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = 'todos-v3';

  // DOM elements
  const titleEl = document.getElementById('title');
  const memoEl = document.getElementById('memo');
  const deadlineEl = document.getElementById('deadline');
  const addBtn = document.getElementById('addBtn');
  const clearAllBtn = document.getElementById('clearAll');
  const todoListEl = document.getElementById('todoList');
  const expiredListEl = document.getElementById('expiredList');
  const doneListEl = document.getElementById('doneList');
  const countActiveEl = document.getElementById('countActive');
  const sortSelect = document.getElementById('sortSelect');

  let todos = []; // persisted items (not including completed)
  let completedInMemory = []; // only in-memory, cleared on reload

  const DAY = 24*60*60*1000;
  const now = () => Date.now();

  // helpers
  const uid = () => 't'+Date.now()+'_'+Math.floor(Math.random()*10000);
  const save = () => localStorage.setItem(KEY, JSON.stringify(todos));
  const load = () => {
    const raw = localStorage.getItem(KEY);
    if (!raw) return [];
    try { return JSON.parse(raw); } catch(e){ console.warn('parse fail', e); return []; }
  };

  function formatDatetime(ts){
    const d = new Date(ts);
    const pad = n => n.toString().padStart(2,'0');
    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
  }

  function addTodo(title, memo, deadlineTs){
    todos.push({
      id: uid(),
      title: title || '(no title)',
      memo: memo || '',
      deadline: deadlineTs || null,
      pinned: false,
      completed: false,
      created: now(),
      movedToExpiredAt: null
    });
    persistAndRender();
  }

  function deleteTodo(id){
    todos = todos.filter(t => t.id !== id);
    persistAndRender();
  }

  function togglePin(id){
    const t = todos.find(x=>x.id===id);
    if (!t) return;
    t.pinned = !t.pinned;
    persistAndRender();
  }

  function markComplete(id){
    const idx = todos.findIndex(x=>x.id===id);
    if (idx === -1) return;
    const t = todos.splice(idx,1)[0];
    t.completed = true;
    completedInMemory.unshift(t);
    persistAndRender();
  }

  // expired: mark movedToExpiredAt if deadline passed and not completed
  function moveExpiredIfNeeded(){
    const nowTs = now();
    let changed = false;
    todos.forEach(t => {
      if (!t.completed && t.deadline && t.deadline < nowTs) {
        if (!t.movedToExpiredAt) { t.movedToExpiredAt = nowTs; changed = true; }
      }
    });
    // delete items that are expired > 7 days since deadline (or moved time)
    const before = todos.length;
    todos = todos.filter(t => {
      if (t.movedToExpiredAt){
        const deleteAfter = (t.deadline || t.movedToExpiredAt) + 7*DAY;
        if (now() >= deleteAfter) return false;
      }
      return true;
    });
    if (todos.length !== before) changed = true;
    if (changed) persistAndRender(false);
  }

  function getColorTag(t){
    if (!t.deadline) return null;
    const diff = t.deadline - now();
    if (diff < 0) return null;
    if (diff <= DAY) return 'danger';
    if (diff <= 3*DAY) return 'warn';
    return null;
  }

  // sorting based on select
  function sortActive(arr){
    const mode = sortSelect.value || 'pin_then_deadline';
    if (mode === 'pin_then_deadline'){
      arr.sort((a,b) => {
        if (a.pinned === b.pinned){
          if (!a.deadline && !b.deadline) return a.created - b.created;
          if (!a.deadline) return 1;
          if (!b.deadline) return -1;
          return a.deadline - b.deadline;
        }
        return a.pinned ? -1 : 1;
      });
    } else if (mode === 'deadline_asc'){
      arr.sort((a,b) => {
        if (!a.deadline && !b.deadline) return a.created - b.created;
        if (!a.deadline) return 1;
        if (!b.deadline) return -1;
        return a.deadline - b.deadline;
      });
    } else if (mode === 'deadline_desc'){
      arr.sort((a,b) => {
        if (!a.deadline && !b.deadline) return a.created - b.created;
        if (!a.deadline) return 1;
        if (!b.deadline) return -1;
        return b.deadline - a.deadline;
      });
    } else if (mode === 'created_asc'){
      arr.sort((a,b) => a.created - b.created);
    }
    return arr;
  }

  function splitLists(){
    const active = [], expired = [];
    todos.forEach(t => {
      if (t.movedToExpiredAt) expired.push(t);
      else active.push(t);
    });
    sortActive(active);
    expired.sort((a,b) => (a.deadline||0) - (b.deadline||0));
    return {active, expired};
  }

  // render
  function render(){
    moveExpiredIfNeeded();
    const {active, expired} = splitLists();
    countActiveEl.textContent = `(${active.length})`;

    // Active
    todoListEl.innerHTML = '';
    if (active.length === 0){
      const p = document.createElement('div'); p.className='muted'; p.textContent='No active todos.'; todoListEl.appendChild(p);
    } else {
      active.forEach(t => todoListEl.appendChild(renderTodoItem(t, false)));
    }

    // Expired
    expiredListEl.innerHTML = '';
    if (expired.length === 0){
      const p = document.createElement('div'); p.className='muted'; p.textContent='No expired items.'; expiredListEl.appendChild(p);
    } else {
      expired.forEach(t => expiredListEl.appendChild(renderTodoItem(t, true)));
    }

    // Done (in-memory)
    doneListEl.innerHTML = '';
    if (completedInMemory.length === 0){
      const p = document.createElement('div'); p.className='muted'; p.textContent='No completed items (they disappear after reload).'; doneListEl.appendChild(p);
    } else {
      completedInMemory.forEach(t => doneListEl.appendChild(renderDoneItem(t)));
    }
  }

  function renderTodoItem(t, isExpired=false){
    const root = document.createElement('div'); root.className = 'todo' + (t.completed ? ' completed' : '');
    const row = document.createElement('div'); row.className = 'todoRow';

    const left = document.createElement('div'); left.className = 'left';
    const title = document.createElement('div'); title.className = 'title'; title.textContent = t.title;
    left.appendChild(title);

    // meta (deadline + tag)
    const meta = document.createElement('div'); meta.className = 'meta';
    const dl = t.deadline ? formatDatetime(t.deadline) : 'No deadline';
    meta.textContent = dl;

    if (!isExpired){
      const tag = getColorTag(t);
      if (tag === 'danger'){ const s = document.createElement('span'); s.className='tag-danger'; s.textContent='期限24h以内'; s.style.marginLeft='8px'; meta.appendChild(s); }
      else if (tag === 'warn'){ const s = document.createElement('span'); s.className='tag-warn'; s.textContent='期限3日以内'; s.style.marginLeft='8px'; meta.appendChild(s); }
    } else {
      const span = document.createElement('span'); span.style.marginLeft='8px'; span.style.color='#b00'; span.textContent='(期限超過)';
      meta.appendChild(span);
    }
    left.appendChild(meta);
    row.appendChild(left);

    // controls: pin, complete, delete
    const controls = document.createElement('div'); controls.className='controls';
    const pinBtn = document.createElement('button'); pinBtn.className='smallBtn pinBtn'; pinBtn.textContent = '📌';
    if (t.pinned) pinBtn.classList.add('pinned');
    pinBtn.title = t.pinned ? 'ピン外す' : 'ピン';
    pinBtn.onclick = (ev) => { ev.stopPropagation(); togglePin(t.id); };
    controls.appendChild(pinBtn);

    const completeBtn = document.createElement('button'); completeBtn.className='smallBtn completeBtn'; completeBtn.textContent = '✓';
    completeBtn.title = '完了';
    completeBtn.onclick = (ev) => { ev.stopPropagation(); markComplete(t.id); };
    controls.appendChild(completeBtn);

    const deleteBtn = document.createElement('button'); deleteBtn.className='smallBtn deleteBtn'; deleteBtn.textContent = '✖';
    deleteBtn.title = '削除';
    deleteBtn.onclick = (ev) => { ev.stopPropagation(); if (confirm('Delete this ToDo?')) deleteTodo(t.id); };
    controls.appendChild(deleteBtn);

    row.appendChild(controls);
    root.appendChild(row);

    // memo area (hidden by default). Toggle when left area tapped, only if memo exists.
    if (t.memo && t.memo.trim() !== ''){
      const memoDiv = document.createElement('div'); memoDiv.className='memo'; memoDiv.style.display='none'; memoDiv.textContent = t.memo;
      root.appendChild(memoDiv);
      left.style.cursor = 'pointer';
      left.addEventListener('click', () => {
        memoDiv.style.display = (memoDiv.style.display === 'none') ? 'block' : 'none';
      });
    } else {
      left.style.cursor = 'default';
    }

    return root;
  }

  // render item for completed list (same memo toggle behavior)
  function renderDoneItem(t){
    const root = document.createElement('div'); root.className = 'todo completed';
    const row = document.createElement('div'); row.className = 'todoRow';
    const left = document.createElement('div'); left.className = 'left';
    const title = document.createElement('div'); title.className = 'title'; title.textContent = t.title;
    left.appendChild(title);
    const meta = document.createElement('div'); meta.className = 'meta';
    meta.textContent = t.deadline ? formatDatetime(t.deadline) : 'No deadline';
    left.appendChild(meta);
    row.appendChild(left);
    root.appendChild(row);

    if (t.memo && t.memo.trim() !== ''){
      const memoDiv = document.createElement('div'); memoDiv.className='memo'; memoDiv.style.display='none'; memoDiv.textContent = t.memo;
      root.appendChild(memoDiv);
      left.style.cursor = 'pointer';
      left.addEventListener('click', () => {
        memoDiv.style.display = (memoDiv.style.display === 'none') ? 'block' : 'none';
      });
    } else {
      left.style.cursor = 'default';
    }
    return root;
  }

  function persistAndRender(saveFlag=true){
    if (saveFlag) save();
    render();
  }

  // init: load persisted todos (completedInMemory starts empty)
  function init(){
    todos = load();
    // ensure numeric deadlines
    todos.forEach(t => { if (t.deadline && typeof t.deadline === 'string') t.deadline = Number(t.deadline); });
    moveExpiredIfNeeded();
    render();
  }

  // UI events
  addBtn.addEventListener('click', () => {
    const title = titleEl.value.trim();
    if (!title) return alert('タイトルを入力してください');
    const memo = memoEl.value.trim();
    let dlTs = null;
    if (deadlineEl.value) dlTs = new Date(deadlineEl.value).getTime();
    addTodo(title, memo, dlTs);
    titleEl.value = '';
    memoEl.value = '';
    deadlineEl.value = '';
  });

  clearAllBtn.addEventListener('click', () => {
    if (!confirm('全ての ToDo を削除します。よいですか？')) return;
    todos = [];
    save();
    render();
  });

  sortSelect.addEventListener('change', () => persistAndRender(false));

  // periodic housekeeping
  setInterval(() => moveExpiredIfNeeded(), 3600*1000);
  setInterval(() => render(), 10000);

  init();

  // expose for debugging
  window._todos = () => todos;
  window._completed = () => completedInMemory;
})();
</script>
</body>
</html>
